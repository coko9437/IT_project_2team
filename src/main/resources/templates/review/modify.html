<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/layout}">
<head>
    <title>리뷰 수정</title>
    <link rel="stylesheet" th:href="@{/css/review/register.css}">
</head>
<body>
<div layout:fragment="content">
    <h1>리뷰 수정</h1>

    <form th:action="@{/review/modify}" method="post">
        <input type="hidden" name="review_id" th:value="${reviewDTO.review_id}">
        <input type="hidden" name="page" th:value="${pageRequestDTO.page}">
        <input type="hidden" name="size" th:value="${pageRequestDTO.size}">
        <input type="hidden" name="type" th:value="${pageRequestDTO.type}">
        <input type="hidden" name="keyword" th:value="${pageRequestDTO.keyword}">

        <label>리뷰 ID</label>
        <p class="form-control-static" th:text="${reviewDTO.review_id}"></p>

        <label for="member_id">작성자 ID</label>
        <input type="text" id="member_id" name="member_id" th:value="${reviewDTO.member_id}" readonly>

        <label for="content">내용</label>
        <textarea id="content" name="content" required th:text="${reviewDTO.content}"></textarea>

        <label for="menu">메뉴</label>
        <input type="text" id="menu" name="menu" required th:value="${reviewDTO.menu}">

        <label for="place">장소</label>
        <input type="text" id="place" name="place" required th:value="${reviewDTO.place}">

        <label for="rating">평점 (1-5)</label>
        <div id="star-rating">
            <span class="star" data-value="1">★</span>
            <span class="star" data-value="2">★</span>
            <span class="star" data-value="3">★</span>
            <span class="star" data-value="4">★</span>
            <span class="star" data-value="5">★</span>
        </div>
        <input type="hidden" id="rating" name="rating" th:value="${reviewDTO.rating}" required>

        <label for="fileInput">사진 업로드:</label>
        <input type="file" id="fileInput" multiple>
        <div id="uploadResult" class="upload-result-area">
            <!-- 기존 이미지 및 새로 업로드된 이미지 미리보기가 여기에 표시됩니다. -->
            <div th:each="fileInfo, stat : ${reviewDTO.uploadFileNames}" class="file-item" th:data-uuid="${fileInfo.uuid}">
                <img th:src="@{/view/{fileName}(fileName=${fileInfo.thumbnailLink})}" th:alt="${fileInfo.fileName}" style="max-width: 100px; max-height: 100px; margin: 5px;">
                <span th:text="${fileInfo.fileName}"></span>
                <button type="button" class="delete-button" th:data-uuid="${fileInfo.uuid}" th:data-file-name="${fileInfo.fileName}">X</button>
                <input type="hidden" name="uploadFileNames[__${stat.index}__].uuid" th:value="${fileInfo.uuid}">
                <input type="hidden" name="uploadFileNames[__${stat.index}__].fileName" th:value="${fileInfo.fileName}">
                <input type="hidden" name="uploadFileNames[__${stat.index}__].img" th:value="${fileInfo.img}">
            </div>
        </div>
        <div id="uploadLoading" class="upload-loading-area" style="display: none;">
            파일 업로드 중...
        </div>

        <label for="emotion">감정</label>
        <select id="emotion" name="emotion" required>
            <option th:each="entry : ${emotionMap}" th:value="${entry.key}" 
                    th:text="${emoticonMap.get(entry.key)}" 
                    th:selected="${entry.key == reviewDTO.emotion}"></option>
        </select>

        <div class="button-area">
            <button type="submit" id="submitButton" disabled>수정 완료</button>
            <button type="button" id="deleteBtn">삭제</button>
            <button type="button" id="cancelBtn">취소</button>
        </div>
    </form>

    <form id="deleteForm" th:action="@{/review/remove}" method="post" style="display: none;">
        <input type="hidden" name="review_id" th:value="${reviewDTO.review_id}">
        <input type="hidden" name="page" th:value="${pageRequestDTO.page}">
        <input type="hidden" name="size" th:value="${pageRequestDTO.size}">
        <input type="hidden" name="type" th:value="${pageRequestDTO.type}">
        <input type="hidden" name="keyword" th:value="${pageRequestDTO.keyword}">
    </form>

</div>
</body>
<th:block layout:fragment="script">
    <script th:src="@{/js/register.js}"></script>
    <script th:inline="javascript">
        const uploadFileNames = [[${reviewDTO.uploadFileNames}]];
        // Set initial rating value for stars
        const initialRating = document.getElementById('rating').value;
        const stars = document.querySelectorAll('#star-rating .star');
        stars.forEach(star => {
            if (star.dataset.value <= initialRating) {
                star.classList.add('filled');
            }
        });

        // Delete confirmation
        document.getElementById('deleteBtn').addEventListener('click', function() {
            if (confirm('정말로 삭제하시겠습니까?')) {
                document.getElementById('deleteForm').submit();
            }
        });

        // Cancel button
        document.getElementById('cancelBtn').addEventListener('click', function() {
            const reviewId = [[${reviewDTO.review_id}]];
            const page = [[${pageRequestDTO.page}]];
            const size = [[${pageRequestDTO.size}]];
            const type = [[${pageRequestDTO.type}]] || '';
            const keyword = [[${pageRequestDTO.keyword}]] || '';

            let url = `/review/read?review_id=${reviewId}&page=${page}&size=${size}`;
            if (type && keyword) {
                url += `&type=${type}&keyword=${keyword}`;
            }
            window.location.href = url;
        });
    </script>
    <script th:src="@{/js/review-detail.js}"></script>
</th:block>
</html>