<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>내 정보 수정</title>
    <style>
        /* 기본 스타일 (최소한의 가독성을 위해 포함) */
        body { font-family: sans-serif; margin: 20px; background-color: #f4f4f4; }
        .container { max-width: 500px; margin: auto; padding: 20px; border: 1px solid #ccc; border-radius: 8px; background-color: #fff; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input[type="text"], input[type="password"], input[type="email"], input[type="tel"], input[type="date"], input[type="number"] {
            width: calc(100% - 22px); padding: 10px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box;
        }
        button { padding: 10px 15px; background-color: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
        button:disabled { background-color: #cccccc; cursor: not-allowed; }
        .error-message { color: red; font-size: 0.9em; margin-top: 5px; display: none; }
        .success-message { color: green; font-size: 0.9em; margin-top: 5px; display: none; }
        #profileImagePreview { width: 100px; height: 100px; border: 1px solid #ddd; border-radius: 50%; overflow: hidden; margin: 10px auto; display: block; }
        #profileImagePreview img { width: 100%; height: 100%; object-fit: cover; display: none; }
        .delete-profile-image-container { display: flex; align-items: center; margin-top: 10px; }
        .delete-profile-image-container input { width: auto; margin-right: 5px; }

        /* 모달 스타일 */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4); justify-content: center; align-items: center; }
        .modal-content { background-color: #fefefe; padding: 20px; border: 1px solid #888; border-radius: 8px; width: 80%; max-width: 400px; text-align: center; }
        .modal-content button { margin-top: 15px; }

    </style>
</head>
<body>
<div class="container">
    <h2>내 정보 수정</h2>
    <!-- multipart/form-data를 사용하여 파일 업로드 가능하도록 설정 -->
    <form id="updateForm" enctype="multipart/form-data">

        <div class="form-group">
            <label for="name">이름</label>
            <input type="text" id="name" name="name" disabled>
        </div>

        <div class="form-group">
            <div>
                <input type="radio" id="male" name="gender" value="남자" disabled>
                <label for="male">남자</label>
                <input type="radio" id="female" name="gender" value="여자" disabled>
                <label for="female">여자</label>
            </div>
        </div>

        <div class="form-group">
            <label for="username">아이디</label>
            <input type="text" id="username" name="username" disabled>
        </div>

        <!-- 비밀번호 변경 필드 -->
        <div class="form-group">
            <label for="currentPassword">현재 비밀번호</label>
            <input type="password" id="currentPassword" name="currentPassword" placeholder="현재 비밀번호를 입력해주세요.">
            <div class="error-message" id="currentPasswordError"></div>
        </div>
        <div class="form-group">
            <label for="newPassword">새 비밀번호</label>
            <input type="password" id="newPassword" name="newPassword" placeholder="새 비밀번호를 8자 이상 20자 이하로 입력해주세요.">
            <div class="error-message" id="newPasswordError"></div>
        </div>
        <div class="form-group">
            <label for="confirmNewPassword">새 비밀번호 확인</label>
            <input type="password" id="confirmNewPassword" name="confirmNewPassword" placeholder="새 비밀번호를 다시 입력해주세요.">
            <div class="error-message" id="confirmNewPasswordError"></div>
        </div>

        <div class="form-group">
            <label for="nickname">닉네임</label>
            <input type="text" id="nickname" name="nickname" placeholder="2자 이상 15자 이하로 입력해주세요.">
            <div class="error-message" id="nicknameError"></div>
        </div>

        <div class="form-group">
            <label for="birthDate">생년월일 (YYYY-MM-DD)</label>
            <input type="date" id="birthDate" name="birthDate" disabled>
        </div>

        <div class="form-group">
            <label for="phoneNumber">전화번호 (010-XXXX-XXXX)</label>
            <input type="tel" id="phoneNumber" name="phoneNumber" pattern="^01(?:0|1|[6-9])-(?:\d{3}|\d{4})-\d{4}$" placeholder="010-1234-5678">
            <div class="error-message" id="phoneNumberError"></div>
        </div>

        <div class="form-group">
            <label for="email">이메일</label>
            <input type="email" id="email" name="email" disabled>
        </div>

        <div class="form-group">
            <label for="profileImage">프로필 사진 (선택사항)</label>
            <input type="file" id="profileImage" name="profileImage" accept="image/*">
            <div id="profileImagePreview">
                <img id="imagePreview" src="" alt="Image Preview">
            </div>
            <div class="delete-profile-image-container">
                <input type="checkbox" id="deleteProfileImage" name="deleteProfileImage">
                <label for="deleteProfileImage">현재 프로필 사진 삭제</label>
            </div>
        </div>

        <button type="submit" id="updateBtn">정보 수정</button>
    </form>
</div>

<!-- 모달 -->
<div id="myModal" class="modal">
    <div class="modal-content">
        <p id="modalMessage"></p>
        <button id="modalConfirmBtn">확인</button>
    </div>
</div>

<script th:inline="javascript">
    // CSRF 토큰 값을 전역 변수로 선언
    const csrfToken = /*[[${_csrf?.token}]]*/ '';
    // 현재 로그인된 사용자의 username을 Thymeleaf에서 JavaScript로 전달 (컨트롤러에서 모델에 member.username을 담아야 함)
    const currentUsername = /*[[${member?.username}]]*/ '';

    // 모달 관련 함수
    const modal = document.getElementById('myModal');
    const modalMessage = document.getElementById('modalMessage');
    const modalConfirmBtn = document.getElementById('modalConfirmBtn');

    function showModal(message, callback) {
        modalMessage.textContent = message;
        modal.style.display = 'flex'; // flex로 설정하여 중앙 정렬
        modalConfirmBtn.onclick = () => {
            modal.style.display = 'none';
            if (callback) callback();
        };
    }

    // 페이지 로드 시 회원 정보 불러오기
    document.addEventListener('DOMContentLoaded', () => {
        if (!currentUsername) {
            showModal('사용자 정보를 찾을 수 없습니다. 다시 로그인해주세요.', () => {
                window.location.href = '/login';
            });
            return;
        }

        fetch(`/api/members/${currentUsername}`, {
            method: 'GET',
            headers: {
                'Accept': 'application/json'
            }
        })
            .then(response => {
                if (response.ok) {
                    return response.json();
                } else {
                    return response.json().then(errorData => {
                        throw new Error(errorData.error || '회원 정보를 불러오는데 실패했습니다.');
                    });
                }
            })
            .then(data => {
                // 폼 필드에 데이터 채우기
                document.getElementById('name').value = data.name || '';
                document.getElementById('username').value = data.username || '';
                document.getElementById('nickname').value = data.nickname || '';
                document.getElementById('phoneNumber').value = data.phoneNumber || '';
                document.getElementById('email').value = data.email || '';
                document.getElementById('birthDate').value = data.birthDate || ''; // LocalDate는 'yyyy-MM-dd' 형식으로 바로 바인딩

                // 성별 라디오 버튼 설정
                if (data.gender === '남자') {
                    document.getElementById('male').checked = true;
                } else if (data.gender === '여자') {
                    document.getElementById('female').checked = true;
                }

                // 프로필 이미지 미리보기 설정
                const imagePreview = document.getElementById('imagePreview');
                if (data.profileThumbnailUrl) { // 썸네일 URL이 있다면 사용
                    imagePreview.src = data.profileThumbnailUrl;
                    imagePreview.style.display = 'block';
                } else if (data.profileImageUrl) { // 썸네일이 없고 원본 URL만 있다면 사용
                    imagePreview.src = data.profileImageUrl;
                    imagePreview.style.display = 'block';
                } else {
                    imagePreview.src = '/images/default-profile.png'; // 기본 이미지
                    imagePreview.style.display = 'block';
                }
            })
            .catch(error => {
                console.error('회원 정보 로드 오류:', error);
                showModal('회원 정보를 불러오는데 실패했습니다: ' + error.message, () => {
                    window.location.href = '/myPage'; // 마이페이지로 돌아가기
                });
            });
    });

    // 프로필 이미지 변경 시 미리보기 업데이트
    document.getElementById('profileImage').addEventListener('change', function(event) {
        const file = event.target.files[0];
        const imagePreview = document.getElementById('imagePreview');
        const deleteCheckbox = document.getElementById('deleteProfileImage');

        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                imagePreview.src = e.target.result;
                imagePreview.style.display = 'block';
                deleteCheckbox.checked = false; // 새 이미지 선택 시 삭제 체크 해제
            };
            reader.readAsDataURL(file);
        } else {
            // 파일 선택 취소 시 기존 이미지 유지 또는 기본 이미지로 돌아감
            // 여기서는 기존 이미지를 유지하도록 처리 (페이지 로드 시 설정된 값)
            // 만약 완전히 초기화하고 싶다면 imagePreview.src = '/images/default-profile.png';
        }
    });

    // 프로필 이미지 삭제 체크박스 클릭 시 미리보기 처리
    document.getElementById('deleteProfileImage').addEventListener('change', function() {
        const imagePreview = document.getElementById('imagePreview');
        const profileImageInput = document.getElementById('profileImage');

        if (this.checked) {
            imagePreview.src = '/images/default-profile.png'; // 미리보기를 기본 이미지로 변경
            profileImageInput.value = ''; // 파일 입력 필드 초기화
            imagePreview.style.display = 'block';
        } else {
            // 체크 해제 시, 현재 DB에 저장된 이미지 또는 기본 이미지로 돌아가야 함 (페이지 로드 시 로직 재활용)
            // 간단하게는 다시 GET 요청을 보내거나, 초기 로드 시의 URL을 저장해두고 사용
            // 여기서는 페이지 새로고침을 통해 다시 로드하는 방식으로 처리하는 것이 가장 확실합니다.
            // 하지만 사용자 경험을 위해 초기 이미지 URL을 저장해두고 사용하는 것이 좋습니다.
            // 복잡성을 줄이기 위해 여기서는 체크 해제 시 아무것도 하지 않거나, 다시 로드하는 것을 제안합니다.
            // 실제 구현에서는 초기 이미지 URL을 JS 변수에 저장해두고 사용하세요.
            // 예를 들어, const initialProfileImageUrl = /*[[${member?.profileThumbnailUrl}]]*/ '';
            // 그리고 체크 해제 시 imagePreview.src = initialProfileImageUrl || '/images/default-profile.png';
        }
    });


    // 폼 제출 이벤트 핸들러
    document.getElementById('updateForm').addEventListener('submit', function(event) {
        event.preventDefault(); // 기본 폼 제출 방지

        // 클라이언트 측 유효성 검사 (선택 사항, 서버 측 검증이 중요)
        const newPassword = document.getElementById('newPassword').value;
        const confirmNewPassword = document.getElementById('confirmNewPassword').value;

        if (newPassword && newPassword !== confirmNewPassword) {
            showModal('새 비밀번호와 비밀번호 확인이 일치하지 않습니다.');
            return;
        }

        const formData = new FormData();
        const memberUpdateDTO = {
            nickname: document.getElementById('nickname').value,
            phoneNumber: document.getElementById('phoneNumber').value,
            currentPassword: document.getElementById('currentPassword').value,
            newPassword: newPassword,
            confirmNewPassword: confirmNewPassword,
            deleteProfileImage: document.getElementById('deleteProfileImage').checked
        };

        // DTO를 JSON 문자열로 변환하여 Blob으로 추가
        formData.append('memberUpdateDTO', new Blob([JSON.stringify(memberUpdateDTO)], { type: 'application/json' }));

        // 프로필 이미지 파일 추가 (선택 사항)
        const profileImageFile = document.getElementById('profileImage').files[0];
        if (profileImageFile) {
            formData.append('profileImage', profileImageFile);
        }

        fetch(`/api/members/${currentUsername}`, {
            method: 'PUT',
            headers: {
                'X-CSRF-TOKEN': csrfToken // CSRF 토큰 추가
            },
            body: formData // FormData는 Content-Type을 자동으로 multipart/form-data로 설정
        })
            .then(response => {
                if (response.ok) {
                    return response.json(); // 성공 시 JSON 응답 파싱
                } else {
                    return response.json().then(errorData => {
                        throw new Error(errorData.error || '정보 수정에 실패했습니다.');
                    });
                }
            })
            .then(data => {
                showModal(data.message || '회원 정보가 성공적으로 수정되었습니다.', () => {
                    window.location.href = '/myPage'; // 수정 완료 후 마이페이지로 리다이렉트
                });
            })
            .catch(error => {
                console.error('회원 정보 수정 오류:', error);
                showModal('회원 정보 수정 실패: ' + error.message);
            });
    });
</script>
</body>
</html>
